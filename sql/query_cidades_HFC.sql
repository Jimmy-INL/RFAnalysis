SELECT a.region, a.cidade AS city, a.year, a.week, concat(a.year,'-',a.week) as "year-w", 
concat(a.cidade,'-',a.year,'-',a.week) as "city-year-week", 
nqi_1800, nqi_2600, nqi_lte, cqi_1800, cqi_2600,
cqi_lte, downlink_avg_thp_1800, downlink_avg_thp_2600, downlink_avg_thp_total, uplink_avg_thp_1800, uplink_avg_thp_2600, uplink_avg_thp_total,
"downlink_traffic_volume 1800(GB)"/1024 as "downlink_traffic_volume 1800(GB)", "downlink_traffic_volume 2600(GB)"/1024 as "downlink_traffic_volume 2600(GB)", 
"downlink_traffic_volume total(GB)"/1024 as "downlink_traffic_volume total(GB)",
average_user_volume_1800, average_user_volume_2600, average_user_volume_total average_user_volume_lte, cqi_umts_cs, cqi_umts_ps cqi_umts_hs,
thp_hsdpa, thp_hsupa, voice_traffic_dl/(8*1024*1024) as "UMTS_traffic_dl (Mb)",(voice_traffic_dl/(8589934592))::real as "UMTS_traffic_dl (Gb)",
retention_4g_1800,retention_4g_2600,retention_4g_total


FROM
(SELECT distinct date_part('year'::text, nqi_daily.date) AS year,
    date_part('week'::text, nqi_daily.date + '1 day'::interval) AS week,
    cells.region,
    uf,
    cidade,
    round((100::real * COALESCE(sum(nqi_daily.qda_good_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qda_good_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qda_bad_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * COALESCE(sum(nqi_daily.qdr_good_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qdr_good_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qdr_bad_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * (1::double precision - COALESCE(sum(nqi_daily.availability_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.availability_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real)) * (1::double precision - COALESCE(sum(nqi_daily.retention_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.retention_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real)) * COALESCE(sum(nqi_daily.qde_dl_good_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qde_dl_good_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qde_dl_bad_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * COALESCE(sum(nqi_daily.qde_ul_good_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qde_ul_good_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qde_ul_bad_attempts) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real) , 1::real))::numeric, 2) AS nqi_1800,
    round((100::real * COALESCE(sum(nqi_daily.qda_good_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qda_good_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qda_bad_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * COALESCE(sum(nqi_daily.qdr_good_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qdr_good_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qdr_bad_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * (1::double precision - COALESCE(sum(nqi_daily.availability_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.availability_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real)) * (1::double precision - COALESCE(sum(nqi_daily.retention_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.retention_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real)) * COALESCE(sum(nqi_daily.qde_dl_good_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qde_dl_good_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qde_dl_bad_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * COALESCE(sum(nqi_daily.qde_ul_good_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qde_ul_good_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qde_ul_bad_attempts) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real) , 1::real))::numeric, 2) AS nqi_2600,
    round((100::real * COALESCE(sum(nqi_daily.qda_good_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qda_good_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qda_bad_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * COALESCE(sum(nqi_daily.qdr_good_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qdr_good_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qdr_bad_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * (1::double precision - COALESCE(sum(nqi_daily.availability_num) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.availability_den) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real)) * (1::double precision - COALESCE(sum(nqi_daily.retention_num) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.retention_den) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real)) * COALESCE(sum(nqi_daily.qde_dl_good_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qde_dl_good_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qde_dl_bad_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real), 1::real) * COALESCE(sum(nqi_daily.qde_ul_good_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) / NULLIF(sum(nqi_daily.qde_ul_good_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf) + sum(nqi_daily.qde_ul_bad_attempts) over (partition by date_part('week'::text, nqi_daily.date + '1 day'::interval), date_part('year'::text, nqi_daily.date), cells.region,cidade,uf), 0::real) , 1::real))::numeric, 2) AS nqi_lte
   FROM lte_kpi.nqi_daily
     JOIN lte_control.cells ON nqi_daily.enodeb = cells.site AND nqi_daily.locellid = cells.cellid
     where cidade in ('RECIFE','CURITIBA','FLORIANÓPOLIS','BELO HORIZONTE','SALVADOR') and date = '2017-07-30') a
	 JOIN
(SELECT distinct date_part('year'::text, main_kpis_lte_daily.date) AS year,
    date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval) AS week,
    cells.region,
    uf,
    cidade,
    round((100::real * COALESCE (SUM(rrc_service_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(rrc_service_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0) ,1) *
    COALESCE (SUM(e_rab_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(e_rab_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),1) *
    COALESCE(SUM(csfb_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(csfb_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),1) *
    (1 -(COALESCE(SUM(service_drop_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(service_drop_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),0))))::numeric, 2) AS cqi_1800,

    round(COALESCE(sum(main_kpis_lte_daily.cell_downlink_avg_thp_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(main_kpis_lte_daily.cell_downlink_avg_thp_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)::numeric, 2) AS downlink_avg_thp_1800,
    round(COALESCE(sum(main_kpis_lte_daily.cell_uplink_avg_thp_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(main_kpis_lte_daily.cell_uplink_avg_thp_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)::numeric, 2) AS uplink_avg_thp_1800,
    sum(main_kpis_lte_daily.downlink_traffic_volume) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf)/(8*1024*1024) AS "downlink_traffic_volume 1800(GB)",
    sum(main_kpis_lte_daily.uplink_traffic_volume) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf)/(8*1024*1024) AS "uplink_traffic_volume 1800(GB)",
    sum(main_kpis_lte_daily.average_user_volume) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) AS average_user_volume_1800,
	round((100::real * (1::real - COALESCE(sum(retention_4g_num) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(retention_4g_den) FILTER (WHERE frequency=1800) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)))::numeric, 2) AS retention_4g_1800,
round((100::real * COALESCE (SUM(rrc_service_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(rrc_service_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0) ,1) *
    COALESCE (SUM(e_rab_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(e_rab_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),1) *
    COALESCE(SUM(csfb_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(csfb_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),1) *
    (1 -(COALESCE(SUM(service_drop_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(service_drop_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),0))))::numeric, 2) AS cqi_2600,

    round(COALESCE(sum(main_kpis_lte_daily.cell_downlink_avg_thp_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(main_kpis_lte_daily.cell_downlink_avg_thp_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)::numeric, 2) AS downlink_avg_thp_2600,
    round(COALESCE(sum(main_kpis_lte_daily.cell_uplink_avg_thp_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(main_kpis_lte_daily.cell_uplink_avg_thp_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)::numeric, 2) AS uplink_avg_thp_2600,
    sum(main_kpis_lte_daily.downlink_traffic_volume) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf)/(8*1024*1024) AS "downlink_traffic_volume 2600(GB)",
    sum(main_kpis_lte_daily.uplink_traffic_volume) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf)/(8*1024*1024) AS "uplink_traffic_volume 2600(GB)",
    sum(main_kpis_lte_daily.average_user_volume) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) AS average_user_volume_2600,
	round((100::real * (1::real - COALESCE(sum(retention_4g_num) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(retention_4g_den) FILTER (WHERE frequency=2600) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)))::numeric, 2) AS retention_4g_2600,

  round((100::real * COALESCE (SUM(rrc_service_num) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(rrc_service_den) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0) ,1) *
    COALESCE (SUM(e_rab_num) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(e_rab_den) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),1) *
    COALESCE(SUM(csfb_num) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(csfb_den) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),1) *
    (1 -(COALESCE(SUM(service_drop_num) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) /
    NULLIF(SUM(service_drop_den) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf),0),0))))::numeric, 2) AS cqi_lte,

    round(COALESCE(sum(main_kpis_lte_daily.cell_downlink_avg_thp_num) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(main_kpis_lte_daily.cell_downlink_avg_thp_den) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)::numeric, 2) AS downlink_avg_thp_total,
    round(COALESCE(sum(main_kpis_lte_daily.cell_uplink_avg_thp_num) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(main_kpis_lte_daily.cell_uplink_avg_thp_den) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)::numeric, 2) AS uplink_avg_thp_total,
    sum(main_kpis_lte_daily.downlink_traffic_volume) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf)/(8*1024*1024) AS "downlink_traffic_volume total(GB)",
    sum(main_kpis_lte_daily.uplink_traffic_volume) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf)/(8*1024*1024) AS "uplink_traffic_volume total(GB)",
    sum(main_kpis_lte_daily.average_user_volume) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) AS average_user_volume_total,
	round((100::real * (1::real - COALESCE(sum(retention_4g_num) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf) / NULLIF(sum(retention_4g_den) over (partition by date_part('week'::text, main_kpis_lte_daily.date + '1 day'::interval), date_part('year'::text, main_kpis_lte_daily.date), cells.region,cidade,uf), 0::real), 1::real)))::numeric, 2) AS retention_4g_total

   FROM lte_kpi.main_kpis_lte_daily
     JOIN lte_control.cells ON main_kpis_lte_daily.enodeb = cells.site AND main_kpis_lte_daily.locellid = cells.cellid

     where cidade in ('RECIFE','CURITIBA','FLORIANÓPOLIS','BELO HORIZONTE','SALVADOR') and date = '2017-07-30') b
	 ON a.year = b.year AND a.week = b.week AND a.cidade = b.cidade
	 
	 JOIN
	 (SELECT a.year, a.week, a.cidade, a.region, nqi_cs, nqi_ps, cqi_umts_cs, cqi_umts_ps, thp_hsdpa, thp_hsupa, 
 hsdpa_users, hsupa_users, voice_traffic_dl
 
 FROM
 (SELECT date_part('year'::text, nqi_daily.date) AS year,
    date_part('week'::text, nqi_daily.date + '1 day'::interval) AS week,cidade,
        CASE
            WHEN "substring"(nqi_daily.rnc, 4, 2) = ANY (ARRAY['AC'::text, 'DF'::text, 'MS'::text, 'MT'::text, 'RO'::text, 'GO'::text, 'TO'::text]) THEN 'CO'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = ANY (ARRAY['AL'::text, 'CE'::text, 'PB'::text, 'PE'::text, 'PI'::text, 'RN'::text]) THEN 'NE'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = 'BA'::text THEN 'BASE'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = 'MG'::text THEN 'MG'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = ANY (ARRAY['PR'::text, 'SC'::text]) THEN 'PRSC'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = 'ES'::text THEN 'ES'::text
            ELSE 'UNKNOWN'::text
        END AS region,
    
    round((100::double precision * COALESCE(sum(nqi_daily.qda_cs_good_attempts) / NULLIF(sum(nqi_daily.qda_cs_good_attempts) + sum(nqi_daily.qda_cs_bad_attempts), 0::real), 1::real) * COALESCE(sum(nqi_daily.qdr_cs_good_attempts) / NULLIF(sum(nqi_daily.qdr_cs_good_attempts) + sum(nqi_daily.qdr_cs_bad_attempts), 0::real), 1::real) * (1::double precision - COALESCE(sum(nqi_daily.retention_cs_num) / NULLIF(sum(nqi_daily.retention_cs_den), 0::real), 0::real)) * (1::double precision - sum(nqi_daily.unavailability) / sum(nqi_daily.gp::real / 30::real)))::numeric, 2) AS nqi_cs,
    round((100::double precision * COALESCE(sum(nqi_daily.qda_ps_good_attempts) / NULLIF(sum(nqi_daily.qda_ps_good_attempts) + sum(nqi_daily.qda_ps_bad_attempts), 0::real), 1::real) * COALESCE(sum(nqi_daily.qdr_ps_good_attempts) / NULLIF(sum(nqi_daily.qdr_ps_good_attempts) + sum(nqi_daily.qdr_ps_bad_attempts), 0::real), 1::real) * (1::double precision - COALESCE(sum(nqi_daily.retention_ps_num) / NULLIF(sum(nqi_daily.retention_ps_den), 0::real), 0::real)) * (1::double precision - sum(nqi_daily.unavailability) / sum(nqi_daily.gp::real / 30::real)) * COALESCE(sum(nqi_daily.user_good_throughput) / NULLIF(sum(nqi_daily.user_good_throughput) + sum(nqi_daily.user_bad_throughput), 0::real), 1::real) * COALESCE(sum(nqi_daily.hsdpa_users) / NULLIF(sum(nqi_daily.hsdpa_users) + sum(nqi_daily.ps_nonhs_users), 0::real), 1::real))::numeric, 2) AS nqi_ps
   FROM umts_kpi.nqi_daily
     JOIN umts_control.cells_db u ON nqi_daily.rnc = u.rnc AND nqi_daily.cellid = u.cellid
	 where cidade in ('RECIFE','CURITIBA','FLORIANÓPOLIS','BELO HORIZONTE','SALVADOR')  and date = '2017-07-30'
  GROUP BY date_part('week'::text, nqi_daily.date + '1 day'::interval),
        CASE
            WHEN "substring"(nqi_daily.rnc, 4, 2) = ANY (ARRAY['AC'::text, 'DF'::text, 'MS'::text, 'MT'::text, 'RO'::text, 'GO'::text, 'TO'::text]) THEN 'CO'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = ANY (ARRAY['AL'::text, 'CE'::text, 'PB'::text, 'PE'::text, 'PI'::text, 'RN'::text]) THEN 'NE'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = 'BA'::text THEN 'BASE'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = 'MG'::text THEN 'MG'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = ANY (ARRAY['PR'::text, 'SC'::text]) THEN 'PRSC'::text
            WHEN "substring"(nqi_daily.rnc, 4, 2) = 'ES'::text THEN 'ES'::text
            ELSE 'UNKNOWN'::text
        END, date_part('year'::text, nqi_daily.date), cidade) a
	JOIN 
	(SELECT date_part('year'::text, main_kpis_daily.date) AS year,
	date_part('week'::text, main_kpis_daily.date + '1 day'::interval) AS week, cidade,
        CASE
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = ANY (ARRAY['AC'::text, 'DF'::text, 'MS'::text, 'MT'::text, 'RO'::text, 'GO'::text, 'TO'::text]) THEN 'CO'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = ANY (ARRAY['AL'::text, 'CE'::text, 'PB'::text, 'PE'::text, 'PI'::text, 'RN'::text]) THEN 'NE'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = 'BA'::text THEN 'BASE'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = 'MG'::text THEN 'MG'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = ANY (ARRAY['PR'::text, 'SC'::text]) THEN 'PRSC'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = 'ES'::text THEN 'ES'::text
            ELSE 'UNKNOWN'::text
        END AS region,
	
	round((100 * COALESCE(SUM(acc_rrc_num) / NULLIF(SUM(acc_rrc_den), 0),1) *
    COALESCE(SUM(acc_cs_rab_num) / NULLIF(SUM(acc_cs_rab_den), 0), 1) *
    (1 - SUM(unavailtime) / (SUM(gp) * 60)::real) *
    (1 - COALESCE(SUM(drop_cs_num) / NULLIF(SUM(drop_cs_den), 0), 1)))::numeric, 2) cqi_umts_cs,

    round(((100::real * COALESCE(sum(main_kpis_daily.acc_rrc_num) / NULLIF(sum(main_kpis_daily.acc_rrc_den), 0::real), 1::real) * COALESCE(sum(main_kpis_daily.acc_ps_rab_num) / NULLIF(sum(main_kpis_daily.acc_ps_rab_den), 0::real), 1::real)) *
    (1 - SUM(unavailtime) / (SUM(gp) * 60)::real) *
    (1 - COALESCE(SUM(drop_ps_num) / NULLIF(SUM(drop_ps_den), 0), 1)))::numeric, 2) cqi_umts_ps,
	
	round((sum(main_kpis_daily.thp_hsdpa) / (sum(main_kpis_daily.gp)::real / 30::double precision))::numeric, 2) AS thp_hsdpa,
    round((sum(main_kpis_daily.thp_hsupa) / (sum(main_kpis_daily.gp)::real / 30::double precision))::numeric, 2) AS thp_hsupa,
	round(sum(main_kpis_daily.hsdpa_users)::numeric, 2) AS hsdpa_users,
    round(sum(main_kpis_daily.hsupa_users)::numeric, 2) AS hsupa_users,
	round(sum(main_kpis_daily.voice_traffic_dl)::numeric, 2) AS voice_traffic_dl
    
   FROM umts_kpi.main_kpis_daily
     JOIN umts_control.cells_db u ON main_kpis_daily.rnc = u.rnc AND main_kpis_daily.cellid = u.cellid
	where cidade in ('RECIFE','CURITIBA','FLORIANÓPOLIS','BELO HORIZONTE','SALVADOR')  and date = '2017-07-30'
     
  GROUP BY date_part('week'::text, main_kpis_daily.date + '1 day'::interval),date_part('year'::text, main_kpis_daily.date),
        CASE
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = ANY (ARRAY['AC'::text, 'DF'::text, 'MS'::text, 'MT'::text, 'RO'::text, 'GO'::text, 'TO'::text]) THEN 'CO'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = ANY (ARRAY['AL'::text, 'CE'::text, 'PB'::text, 'PE'::text, 'PI'::text, 'RN'::text]) THEN 'NE'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = 'BA'::text THEN 'BASE'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = 'MG'::text THEN 'MG'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = ANY (ARRAY['PR'::text, 'SC'::text]) THEN 'PRSC'::text
            WHEN "substring"(main_kpis_daily.rnc, 4, 2) = 'ES'::text THEN 'ES'::text
            ELSE 'UNKNOWN'::text
        END,cidade) b
	
	ON a.year = b.year AND a.week =b.week and a.cidade = b.cidade) c
	 ON a.year = c.year AND a.week = c.week AND a.cidade = c.cidade order by a.cidade